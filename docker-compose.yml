version: '3.8'

services:
  # ComfyUI Service for Image Generation
  comfyui:
    image: comfyanonymous/comfyanonymous_comfyui:latest
    container_name: comfyui
    restart: unless-stopped
    ports:
      - "8188:8188"
    volumes:
      # Mount local models directory instead of using Docker volume
      - /d/ComfyUI/models:/models
      - comfyui_output:/output
      - comfyui_input:/input
    environment:
      - CUDA_VISIBLE_DEVICES: "0"  # Use first GPU
    deploy:
      resources:
        reservations:
          devices:
            - device_ids: ['0']
              capabilities: [gpu]
    networks:
      - cyber_jianghu

  # Qdrant Vector Database
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"
      - "6334:6334"  # Web UI
    volumes:
      - qdrant_storage:/qdrant/storage
    networks:
      - cyber_jianghu

  # Redis Cache (for production)
  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - cyber_jianghu

  # Cyber-Jianghu Server
  server:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: cyber-jianghu-server
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - ZHIPUAI_API_KEY: ${ZHIPUAI_API_KEY}
      - COMFYUI_URL: http://comfyui:8188
      - QDRANT_URL: http://qdrant:6333
      - REDIS_URL: redis://redis:6379/0
      - AUDIO_CACHE_DIR: /data/audio_cache
      - IMAGE_CACHE_DIR: /data/image_cache
    volumes:
      - audio_cache:/data/audio_cache
      - image_cache:/data/image_cache
    depends_on:
      - qdrant
      - redis
    networks:
      - cyber_jianghu

networks:
  cyber_jianghu:
    driver: bridge

volumes:
  comfyui_models:
  comfyui_output:
  comfyui_input:
  qdrant_storage:
  redis_data:
  audio_cache:
  image_cache:
